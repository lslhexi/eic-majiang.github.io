<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»ˆæå››å­—éº»å°†æ®µä½ç»Ÿè®¡ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #fef2f2 0%, #fef3c7 100%);
            min-height: 100vh;
            padding: 1rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .title {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .title h1 {
            font-size: 2.5rem;
            color: #991b1b;
            margin-bottom: 0.5rem;
        }
        
        .title p {
            color: #6b7280;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-left: 4px solid;
        }
        
        .stat-card.blue { border-left-color: #3b82f6; }
        .stat-card.green { border-left-color: #10b981; }
        .stat-card.purple { border-left-color: #8b5cf6; }
        .stat-card.yellow { border-left-color: #f59e0b; }
        
        .stat-content {
            display: flex;
            align-items: center;
        }
        
        .stat-icon {
            width: 2rem;
            height: 2rem;
            margin-right: 0.75rem;
        }
        
        .stat-text h3 {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        
        .stat-text p {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .card h2 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        
        .input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .input-group input, .input-group select {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            outline: none;
        }
        
        .input-group input:focus, .input-group select:focus {
            box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.2);
            border-color: #dc2626;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }
        
        .btn-primary {
            background: #dc2626;
            color: white;
        }
        
        .btn-primary:hover {
            background: #b91c1c;
        }
        
        .btn-success {
            background: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .player-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .player-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: background-color 0.2s;
        }
        
        .player-item:hover {
            background: #f9fafb;
        }

        .player-item.vip-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fcd34d 100%);
            border: 2px solid #f59e0b;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            position: relative;
            overflow: hidden;
        }

        .player-item.vip-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: vip-shimmer 3s infinite;
            pointer-events: none;
        }

        .player-item.vip-card:hover {
            background: linear-gradient(135deg, #fde68a 0%, #fcd34d 50%, #fbbf24 100%);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
        }

        @keyframes vip-shimmer {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }
        
        .player-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .player-rank {
            font-size: 1.125rem;
            font-weight: bold;
            margin-right: 0.75rem;
        }
        
        .rank-1 { color: #d97706; }
        .rank-2 { color: #6b7280; }
        .rank-3 { color: #ea580c; }
        .rank-other { color: #9ca3af; }
        
        .player-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }
        
        .rank-info {
            background: #f3f4f6;
            padding: 0.5rem;
            border-radius: 0.375rem;
        }
        
        .rank-name {
            font-weight: bold;
            color: #7c3aed;
        }
        
        .rank-desc {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .rank-table {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .rank-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: background-color 0.2s;
        }
        
        .rank-item:hover {
            background: #f9fafb;
        }
        
        .rank-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        .rank-item-name {
            font-weight: bold;
            color: #7c3aed;
        }
        
        .rank-item-range {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .rank-item-desc {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        
        .empty-icon {
            width: 3rem;
            height: 3rem;
            margin: 0 auto 1rem;
            color: #d1d5db;
        }

        .shop-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f9fafb;
        }

        .shop-item-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .shop-item-name {
            font-weight: bold;
            color: #1f2937;
            flex: 1;
        }

        .shop-item-price {
            color: #dc2626;
            font-weight: bold;
        }

        .shop-item-desc {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.75rem;
        }

        .shop-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .player-select {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }

        .item-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .vip-name {
            background: linear-gradient(90deg, #fbbf24, #f59e0b, #d97706, #f59e0b, #fbbf24);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
            animation: vip-shine 3s ease-in-out infinite;
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .vip-crown-icon {
            display: inline-block;
            animation: vip-crown 2s ease-in-out infinite;
            filter: drop-shadow(0 0 3px rgba(251, 191, 36, 0.8));
        }

        @keyframes vip-shine {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes vip-crown {
            0%, 100% {
                transform: scale(1) rotate(0deg);
            }
            25% {
                transform: scale(1.15) rotate(-8deg);
            }
            75% {
                transform: scale(1.15) rotate(8deg);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // å›¾æ ‡ç»„ä»¶...
        const PlusCircle = () => React.createElement('svg', { 
            width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
            strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' 
        }, [
            React.createElement('circle', { key: 'circle', cx: 12, cy: 12, r: 10 }),
            React.createElement('path', { key: 'path', d: 'M12 8v8m-4-4h8' })
        ]);
        
        const Trash2 = () => React.createElement('svg', { 
            width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
            strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' 
        }, [
            React.createElement('path', { key: 'path1', d: 'M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2' }),
            React.createElement('line', { key: 'line1', x1: 10, y1: 11, x2: 10, y2: 17 }),
            React.createElement('line', { key: 'line2', x1: 14, y1: 11, x2: 14, y2: 17 })
        ]);
        
        const Trophy = (props) => React.createElement('svg', { 
            width: props?.size || 16, height: props?.size || 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
            strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', className: props?.className 
        }, [
            React.createElement('path', { key: 'path1', d: 'M6 9H4.5a2.5 2.5 0 0 1 0-5H6' }),
            React.createElement('path', { key: 'path2', d: 'M18 9h1.5a2.5 2.5 0 0 0 0-5H18' }),
            React.createElement('path', { key: 'path3', d: 'M4 22h16' }),
            React.createElement('path', { key: 'path4', d: 'M10 14.66V17c0 .55.47.98.97 1.21C11.25 18.48 11.61 18.65 12 18.65s.75-.17 1.03-.44C13.53 17.98 14 17.55 14 17v-2.34c0-.59-.26-1.16-.68-1.56L12 12l-1.32 1.1c-.42.4-.68.97-.68 1.56Z' }),
            React.createElement('path', { key: 'path5', d: 'M6 9a6 6 0 0 0 12 0H6Z' })
        ]);
        
        const Users = () => React.createElement('svg', { 
            width: 32, height: 32, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
            strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', className: 'stat-icon'
        }, [
            React.createElement('path', { key: 'path1', d: 'M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2' }),
            React.createElement('circle', { key: 'circle1', cx: 9, cy: 7, r: 4 }),
            React.createElement('path', { key: 'path2', d: 'M22 21v-2a4 4 0 0 0-3-3.87' }),
            React.createElement('path', { key: 'path3', d: 'M16 3.13a4 4 0 0 1 0 7.75' })
        ]);
        
        const TrendingUp = () => React.createElement('svg', { 
            width: 32, height: 32, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
            strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', className: 'stat-icon'
        }, [
            React.createElement('polyline', { key: 'polyline', points: '22,7 13.5,15.5 8.5,10.5 2,17' }),
            React.createElement('polyline', { key: 'polyline2', points: '16,7 22,7 22,13' })
        ]);
        
        const Award = () => React.createElement('svg', { 
            width: 32, height: 32, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
            strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', className: 'stat-icon'
        }, [
            React.createElement('circle', { key: 'circle', cx: 12, cy: 8, r: 6 }),
            React.createElement('path', { key: 'path1', d: 'M15.477 12.89 17 22l-5-3-5 3 1.523-9.11' })
        ]);

        const ShoppingCart = () => React.createElement('svg', { 
            width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
            strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' 
        }, [
            React.createElement('circle', { key: 'circle1', cx: 9, cy: 21, r: 1 }),
            React.createElement('circle', { key: 'circle2', cx: 20, cy: 21, r: 1 }),
            React.createElement('path', { key: 'path', d: 'M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6' })
        ]);

        const Shield = () => React.createElement('svg', { 
            width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
            strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' 
        }, [
            React.createElement('path', { key: 'path', d: 'M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z' })
        ]);

        const Zap = () => React.createElement('svg', { 
            width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
            strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' 
        }, [
            React.createElement('polygon', { key: 'polygon', points: '13 2 3 14 12 14 11 22 21 10 12 10 13 2' })
        ]);

        const Crown = () => React.createElement('svg', { 
            width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
            strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' 
        }, [
            React.createElement('path', { key: 'path1', d: 'M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5z' }),
            React.createElement('path', { key: 'path2', d: 'M5 16h14v3H5v-3z' })
        ]);

        const defaultFirebaseConfig = {
            apiKey: "AIzaSyBvGOuImmwVJvMvzBFKjZjPtCLuc_DoLBw",
            authDomain: "majiang-c2f8c.firebaseapp.com",
            databaseURL: "https://majiang-c2f8c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "majiang-c2f8c",
            storageBucket: "majiang-c2f8c.firebasestorage.app",
            messagingSenderId: "1091135402516",
            appId: "1:1091135402516:web:ebdfc04c02ed8c8b2bed01"
        };
        const ADMIN_PASSCODE = 'lsysb';

        const MahjongScoreTracker = () => {
            const [players, setPlayers] = useState([]);
            const [newPlayerName, setNewPlayerName] = useState('');
            const [roundScores, setRoundScores] = useState({});  // å­˜å‚¨æœ¬å±€æ¯ä¸ªç©å®¶çš„åˆ†æ•°å˜åŒ–
            const [roundCount, setRoundCount] = useState(0);
            const [selectedPlayerForShop, setSelectedPlayerForShop] = useState(null);  // é€‰æ‹©è´­ä¹°é“å…·çš„ç©å®¶
            const [firebaseConfig, setFirebaseConfig] = useState(null);
            const [db, setDb] = useState(null);
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [useFirebase, setUseFirebase] = useState(false);
            const [showFirebaseConfig, setShowFirebaseConfig] = useState(false);
            const [isSaving, setIsSaving] = useState(false); // é˜²æ­¢å¾ªç¯ä¿å­˜çš„æ ‡å¿—
            const [configInput, setConfigInput] = useState(defaultFirebaseConfig);
            const [isAdmin, setIsAdmin] = useState(false);
            const [passcodeInput, setPasscodeInput] = useState('');
            const [currentUser, setCurrentUser] = useState({ role: 'visitor', playerId: null, username: '' });
            const [authMode, setAuthMode] = useState('login'); // login | register
            const [authForm, setAuthForm] = useState({ username: '', displayName: '', password: '', confirmPassword: '' });

            // åˆå§‹åŒ–Firebase
            const initFirebase = (config) => {
                try {
                    if (!window.firebase) {
                        console.error('Firebase SDKæœªåŠ è½½');
                        alert('Firebase SDKæœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                        return false;
                    }
                    // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œå…ˆåˆ é™¤æ—§å®ä¾‹
                    try {
                        window.firebase.app().delete();
                    } catch (e) {
                        // å¿½ç•¥é”™è¯¯ï¼Œå¯èƒ½æ²¡æœ‰åˆå§‹åŒ–è¿‡
                    }
                    const app = window.firebase.initializeApp(config);
                    const database = window.firebase.database(app);
                    setDb(database);
                    setFirebaseConfig(config);
                    setIsFirebaseReady(true);
                    setUseFirebase(true);
                    // ä¿å­˜é…ç½®åˆ°localStorage
                    localStorage.setItem('firebaseConfig', JSON.stringify(config));
                    return true;
                } catch (error) {
                    console.error('Firebaseåˆå§‹åŒ–å¤±è´¥:', error);
                    alert('Firebaseåˆå§‹åŒ–å¤±è´¥: ' + error.message);
                    return false;
                }
            };

            // ä»localStorageåŠ è½½Firebaseé…ç½®
            useEffect(() => {
                const savedConfig = localStorage.getItem('firebaseConfig');
                if (savedConfig) {
                    try {
                        const config = JSON.parse(savedConfig);
                        setConfigInput(config);
                        initFirebase(config);
                    } catch (e) {
                        console.error('åŠ è½½Firebaseé…ç½®å¤±è´¥:', e);
                    }
                }
            }, []);

            useEffect(() => {
                if (currentUser.role === 'player' && currentUser.playerId) {
                    setSelectedPlayerForShop(currentUser.playerId);
                } else if (currentUser.role !== 'player') {
                    setSelectedPlayerForShop(null);
                }
            }, [currentUser]);

            // ä»Firebaseæˆ–localStorageåŠ è½½æ•°æ®
            useEffect(() => {
                if (isFirebaseReady && db) {
                    // ä½¿ç”¨Firebaseå®æ—¶ç›‘å¬
                    const playersRef = db.ref('players');
                    const roundCountRef = db.ref('roundCount');

                    playersRef.on('value', (snapshot) => {
                        if (isSaving) return; // å¦‚æœæ­£åœ¨ä¿å­˜ï¼Œå¿½ç•¥è¿™æ¬¡æ›´æ–°
                        const data = snapshot.val();
                        if (data) {
                            let playersArray;
                            if (Array.isArray(data)) {
                                playersArray = data;
                            } else if (typeof data === 'object' && data !== null) {
                                playersArray = Object.values(data);
                            } else {
                                playersArray = [];
                            }
                            
                            if (playersArray && playersArray.length > 0) {
                                const playersWithItems = playersArray.map(p => {
                                    if (!p || typeof p !== 'object') return null;
                                    const items = p.items || { doubleCard: false, protectCard: false, lossProtectCard: false, vip: 0 };
                                    if (typeof items.vip === 'boolean') {
                                        items.vip = items.vip ? 3 : 0;
                                    }
                                    return { 
                                        ...p, 
                                        items: items,
                                        username: p.username || p.name || '',
                                        password: p.password || ''
                                    };
                                }).filter(p => p !== null);
                                
                                setIsSaving(true);
                                setPlayers(playersWithItems);
                                setTimeout(() => setIsSaving(false), 100);
                            } else {
                                setPlayers([]);
                            }
                        } else {
                            setPlayers([]);
                        }
                    });

                    roundCountRef.on('value', (snapshot) => {
                        if (isSaving) return;
                        const count = snapshot.val();
                        if (count !== null) {
                            setIsSaving(true);
                            setRoundCount(count);
                            setTimeout(() => setIsSaving(false), 100);
                        }
                    });

                    return () => {
                        playersRef.off();
                        roundCountRef.off();
                    };
                } else {
                    // ä½¿ç”¨localStorageï¼ˆå…¼å®¹æ¨¡å¼ï¼‰
                    const savedPlayers = localStorage.getItem('mahjongPlayers');
                    if (savedPlayers) {
                        const parsed = JSON.parse(savedPlayers);
                        const playersWithItems = parsed.map(p => {
                            const items = p.items || { doubleCard: false, protectCard: false, lossProtectCard: false, vip: 0 };
                            if (typeof items.vip === 'boolean') {
                                items.vip = items.vip ? 3 : 0;
                            }
                            return { 
                                ...p, 
                                items: items,
                                username: p.username || p.name || '',
                                password: p.password || ''
                            };
                        });
                        setPlayers(playersWithItems);
                    }
                    const savedRoundCount = localStorage.getItem('mahjongRoundCount');
                    if (savedRoundCount) {
                        setRoundCount(parseInt(savedRoundCount, 10));
                    }
                }
            }, [isFirebaseReady, db]);

            // ä¿å­˜ç©å®¶æ•°æ®åˆ°Firebaseæˆ–localStorage
            useEffect(() => {
                if (isSaving) return; // å¦‚æœæ­£åœ¨ä»FirebaseåŠ è½½ï¼Œä¸ä¿å­˜
                if (players.length === 0 && !isFirebaseReady) return; // åˆå§‹åŠ è½½æ—¶ä¸ä¿å­˜ç©ºæ•°ç»„

                const canWriteFirebase = isAdmin || currentUser.role === 'player';

                if (isFirebaseReady && db && useFirebase && canWriteFirebase) {
                    // ä¿å­˜åˆ°Firebase
                    setIsSaving(true);
                    db.ref('players').set(players).then(() => {
                        console.log('æ•°æ®å·²ä¿å­˜åˆ°Firebase');
                        setTimeout(() => setIsSaving(false), 500);
                    }).catch((error) => {
                        console.error('ä¿å­˜åˆ°Firebaseå¤±è´¥:', error);
                        alert('ä¿å­˜å¤±è´¥: ' + error.message);
                        setIsSaving(false);
                    });
                } else {
                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('mahjongPlayers', JSON.stringify(players));
                }

                // åŒæ­¥roundScores: ç¡®ä¿æ–°æ·»åŠ çš„ç©å®¶æœ‰è¾“å…¥æ¡†
                setRoundScores(prev => {
                    const updated = {};
                    if (Array.isArray(players)) {
                        players.forEach(p => {
                            if (p && p.id) {
                                updated[p.id] = prev[p.id] !== undefined ? prev[p.id] : '';
                            }
                        });
                    }
                    return updated;
                });
            }, [players, isFirebaseReady, db, useFirebase, isSaving]);

            // ä¿å­˜å›åˆæ•°åˆ°Firebaseæˆ–localStorage
            useEffect(() => {
                if (isSaving) return;
                const canWriteFirebase = isAdmin || currentUser.role === 'player';
                if (isFirebaseReady && db && useFirebase && canWriteFirebase) {
                    setIsSaving(true);
                    db.ref('roundCount').set(roundCount).then(() => {
                        setTimeout(() => setIsSaving(false), 500);
                    }).catch((error) => {
                        console.error('ä¿å­˜å›åˆæ•°å¤±è´¥:', error);
                        setIsSaving(false);
                    });
                } else {
                    localStorage.setItem('mahjongRoundCount', roundCount);
                }
            }, [roundCount, isFirebaseReady, db, useFirebase, isSaving]);

            // æ®µä½è¡¨æ•°æ®
            const rankTable = [
                { min: -2000, max: -1601, name: 'ç ´äº§è·‘è·¯', description: 'çº¢æ¸©è­¦å‘Šï¼Œéº»å°†è¡€äºï¼Œå»ºè®®ä¸‹å–„ä½“æ¯' },
                { min: -1600, max: -1201, name: 'åƒåœŸé’é“œ', description: 'è¾“åˆ°æ€€ç–‘äººç”Ÿï¼Œè¿æ°”ä¸æŠ€æœ¯åŒé‡æ‰“å‡»' },
                { min: -1200, max: -801, name: 'éœ‰è¿è¿è¿', description: 'è¿ç‚¹ä¸‰èƒ¡ï¼Œèƒ¡ä¸€æ‰‹éƒ½å«Œéº»çƒ¦' },
                { min: -800, max: -401, name: 'åˆ®é£ä¸‹é›¨', description: 'æ”¾ç‚®ä¸åœï¼Œé£å£°é›¨å£°éº»å°†å£°å£°å‚¬å‘½' },
                { min: -400, max: -1, name: 'ç¿»èº«åœ¨æœ›', description: 'è¾“å¤šèµ¢å°‘ï¼Œä½†æ€»æ„Ÿè§‰èƒ¡è½¬ä¹¾å¤' },
                { min: 0, max: 399, name: 'å¹³å¹³æ— å¥‡', description: 'æ°´å¹³ä¸­è§„ä¸­çŸ©ï¼Œç¤¾æå‹æ‰“ç‰Œæ—¥å¸¸' },
                { min: 400, max: 799, name: 'ç¨³æ‰ç¨³æ‰“', description: 'ç¨³å¥è¿è¥ï¼Œå¼€å§‹èµ·åœºï¼Œç†åˆ°ç‚¹æ„Ÿè§‰' },
                { min: 800, max: 1199, name: 'å¤§æ€å››æ–¹', description: 'èƒ¡ç‰Œå¦‚å–æ°´ï¼Œå¯¹å®¶å«è‹¦ä¸è¿­' },
                { min: 1200, max: 1599, name: 'é›€å›éœ¸ä¸»', description: 'èƒœç‡å‹åˆ¶ï¼Œé å®åŠ›å°ç¥' },
                { min: 1600, max: 2000, name: 'å¤©èƒ¡ç‹è€…', description: 'ä¸€æ‰“ä¸‰æ— å‹åŠ›ï¼Œæ‰“è°è°å¤´' }
            ];

            // å•†åŸé“å…·æ•°æ®
            const shopItems = [
                {
                    id: 'doubleCard',
                    name: 'åŒå€ç§¯åˆ†å¡',
                    description: 'ä¸‹æ¬¡è®°åˆ†æ—¶ï¼Œå¦‚æœèµ¢é’±ï¼Œç§¯åˆ†åŒå€ï¼›å¦‚æœè¾“é’±ï¼Œå¡ç‰‡å¤±æ•ˆ',
                    price: 150,
                    icon: Zap
                },
                {
                    id: 'protectCard',
                    name: 'æ‰æ®µä¿æŠ¤å¡',
                    description: 'ä¸‹æ¬¡è®°åˆ†æ—¶å¦‚æœè¾“äº†ä¸”ä¼šæ‰æ®µï¼Œåˆ™ç§¯åˆ†åˆšå¥½æ‰£é™¤åˆ°æ®µä½è¾¹ç¼˜ï¼›å¦‚æœèµ¢é’±ï¼Œå¡ç‰‡å¤±æ•ˆ',
                    price: 100,
                    icon: Shield
                },
                {
                    id: 'lossProtectCard',
                    name: 'æ‰åˆ†ä¿æŠ¤å¡',
                    description: 'ä¸‹æ¬¡è®°åˆ†æ—¶ï¼Œå¦‚æœè¾“äº†åˆ™ä¸æ‰£åˆ†ï¼›æ— è®ºè¾“èµ¢ï¼Œä½¿ç”¨åå¤±æ•ˆ',
                    price: 150,
                    icon: Shield
                },
                {
                    id: 'vip',
                    name: 'VIPä¼šå‘˜',
                    description: 'è®°åˆ†ä¸‰æ¬¡åå¤±æ•ˆï¼Œåå­—åœ¨ç§¯åˆ†æ¦œä¸Šæ˜¾ç¤ºç‰¹æ•ˆ',
                    price: 200,
                    icon: Crown
                }
            ];

            const getRankInfo = (score) => {
                for (let rank of rankTable) {
                    if (score >= rank.min && score <= rank.max) {
                        return rank;
                    }
                }
                if (score < -2000) return { ...rankTable[0], name: 'ç ´äº§è·‘è·¯', description: 'å·²ç»è¶…å‡ºç ´äº§çº¿' };
                if (score > 2000) return { ...rankTable[rankTable.length - 1], name: 'å¤©èƒ¡ç‹è€…', description: 'å·²è¾¾ä¼ è¯´å¢ƒç•Œ' };
                return rankTable[5];
            };

            const addPlayer = () => {
                if (newPlayerName.trim() && !players.find(p => p.name === newPlayerName.trim())) {
                    const newPlayer = {
                        id: Date.now(),
                        name: newPlayerName.trim(),
                        username: newPlayerName.trim(),
                        password: '',
                        score: 0,
                        gameCount: 0,
                        winCount: 0,
                        history: [],
                        items: {
                            doubleCard: false,  // åŒå€ç§¯åˆ†å¡
                            protectCard: false,  // æ‰æ®µä¿æŠ¤å¡
                            lossProtectCard: false,  // æ‰åˆ†ä¿æŠ¤å¡
                            vip: 0  // VIPä¼šå‘˜ï¼ˆä½¿ç”¨æ¬¡æ•°ï¼Œ0è¡¨ç¤ºæ²¡æœ‰ï¼‰
                        }
                    };
                    setPlayers([...players, newPlayer]);
                    setNewPlayerName('');
                }
            };

            const registerPlayer = () => {
                if (!authForm.username.trim() || !authForm.password.trim()) {
                    alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                    return;
                }
                if (authForm.password !== authForm.confirmPassword) {
                    alert('ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´');
                    return;
                }
                if (players.find(p => (p.username || '').toLowerCase() === authForm.username.trim().toLowerCase())) {
                    alert('è¯¥ç”¨æˆ·åå·²è¢«æ³¨å†Œ');
                    return;
                }
                const displayName = authForm.displayName.trim() || authForm.username.trim();
                const newPlayer = {
                    id: Date.now(),
                    name: displayName,
                    username: authForm.username.trim(),
                    password: authForm.password,
                    score: 0,
                    gameCount: 0,
                    winCount: 0,
                    history: [],
                    items: {
                        doubleCard: false,
                        protectCard: false,
                        lossProtectCard: false,
                        vip: 0
                    }
                };
                setPlayers([...players, newPlayer]);
                setAuthForm({ username: '', displayName: '', password: '', confirmPassword: '' });
                setAuthMode('login');
                alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ä½¿ç”¨è´¦å·ç™»å½•');
            };

            const loginPlayer = () => {
                if (!authForm.username.trim() || !authForm.password.trim()) {
                    alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                    return;
                }
                const found = players.find(p => (p.username || '').toLowerCase() === authForm.username.trim().toLowerCase());
                if (!found || found.password !== authForm.password) {
                    alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                    return;
                }
                setCurrentUser({ role: 'player', playerId: found.id, username: found.username || found.name || '' });
                setAuthForm({ username: '', displayName: '', password: '', confirmPassword: '' });
                alert(`æ¬¢è¿å›æ¥ï¼Œ${found.name || found.username}!`);
            };

            const logoutUser = () => {
                setCurrentUser({ role: 'visitor', playerId: null, username: '' });
                setIsAdmin(false);
                setSelectedPlayerForShop(null);
            };

            const deletePlayer = (playerId) => {
                setPlayers(players.filter(p => p.id !== playerId));
                setRoundScores(prev => {
                    const updated = { ...prev };
                    delete updated[playerId];
                    return updated;
                });
            };

            // è·å–æ®µä½è¾¹ç•Œå€¼ï¼ˆå½“å‰æ®µä½çš„æœ€å°å€¼ï¼‰
            const getCurrentRankMin = (score) => {
                for (let rank of rankTable) {
                    if (score >= rank.min && score <= rank.max) {
                        return rank.min;
                    }
                }
                if (score < -2000) return -2000;
                if (score > 2000) return 2000;
                return 0;
            };

            const buyItem = (playerId, itemId) => {
                if (!isAdmin && !(currentUser.role === 'player' && currentUser.playerId === playerId)) {
                    alert('ä»…ç®¡ç†å‘˜æˆ–ç™»å½•çš„ç©å®¶æœ¬äººå¯ä»¥è´­ä¹°é“å…·');
                    return;
                }
                if (!Array.isArray(players)) return;
                const player = players.find(p => p && p.id === playerId);
                if (!player) return;

                const item = shopItems.find(i => i.id === itemId);
                if (!item) return;

                // VIPå¯ä»¥é‡å¤è´­ä¹°ï¼Œå¢åŠ ä½¿ç”¨æ¬¡æ•°
                if (itemId === 'vip') {
                    // VIPè´­ä¹°æ—¶å¢åŠ 3æ¬¡ä½¿ç”¨æ¬¡æ•°ï¼ˆå…è®¸è´Ÿç§¯åˆ†è´­ä¹°ï¼‰
                    setPlayers(players.map(p => {
                        if (p.id === playerId) {
                            const currentVip = p.items.vip || 0;
                            return {
                                ...p,
                                score: p.score - item.price,
                                items: {
                                    ...p.items,
                                    vip: currentVip + 3
                                }
                            };
                        }
                        return p;
                    }));
                    setSelectedPlayerForShop(null);
                    alert(`${player.name} æˆåŠŸè´­ä¹° ${item.name}ï¼å‰©ä½™ç§¯åˆ†ï¼š${player.score - item.price}ï¼ŒVIPå‰©ä½™æ¬¡æ•°ï¼š${(player.items.vip || 0) + 3}`);
                    return;
                }

                // å…¶ä»–é“å…·æ£€æŸ¥æ˜¯å¦å·²æœ‰
                if (player.items[itemId]) {
                    alert('æ‚¨å·²ç»æ‹¥æœ‰è¯¥é“å…·ï¼');
                    return;
                }

                // å…è®¸è´Ÿç§¯åˆ†è´­ä¹°ï¼Œç›´æ¥æ‰£é™¤ç§¯åˆ†

                // è´­ä¹°é“å…·ï¼šæ‰£é™¤ç§¯åˆ†ï¼Œæ·»åŠ é“å…·
                setPlayers(players.map(p => {
                    if (p.id === playerId) {
                        return {
                            ...p,
                            score: p.score - item.price,
                            items: {
                                ...p.items,
                                [itemId]: true
                            }
                        };
                    }
                    return p;
                }));
                
                // è´­ä¹°æˆåŠŸåæ¸…ç©ºé€‰æ‹©
                setSelectedPlayerForShop(null);
                alert(`${player.name} æˆåŠŸè´­ä¹° ${item.name}ï¼å‰©ä½™ç§¯åˆ†ï¼š${player.score - item.price}`);
            };

            const recordRound = () => {
                // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªç©å®¶å­˜åœ¨
                if (!Array.isArray(players) || players.length === 0) {
                    alert('æ²¡æœ‰ç©å®¶å¯è®°å½•');
                    return;
                }
                if (!isAdmin && currentUser.role !== 'player') {
                    alert('è¯·å…ˆç™»å½•ç©å®¶è´¦å·æˆ–è¿›å…¥ç®¡ç†å‘˜æ¨¡å¼åå†è®°å½•åˆ†æ•°');
                    return;
                }
                // æ›´æ–°æ¯ä¸ªç©å®¶çš„åˆ†æ•°å’Œç»Ÿè®¡
                const updatedPlayers = players.map(player => {
                    // ç¡®ä¿playeræ˜¯æœ‰æ•ˆå¯¹è±¡
                    if (!player || typeof player !== 'object') {
                        return null;
                    }
                    const canEditThisPlayer = isAdmin || (currentUser.role === 'player' && currentUser.playerId === player.id);
                    if (!canEditThisPlayer) {
                        return {
                            ...player
                        };
                    }
                    
                    const scoreInput = roundScores[player.id];
                    // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºæˆ–æœªå®šä¹‰ï¼Œè®¤ä¸ºè¯¥ç©å®¶æœªå‚åŠ æœ¬æ¬¡æ¸¸æˆ
                    const participated = scoreInput !== undefined && scoreInput !== null && scoreInput !== '';
                    
                    if (participated) {
                        // å‚åŠ äº†ï¼šæ›´æ–°åˆ†æ•°ã€å±€æ•°ã€èƒœåœº
                        let change = parseInt(scoreInput, 10);
                        const validChange = isNaN(change) ? 0 : change;
                        
                        // åº”ç”¨é“å…·æ•ˆæœ
                        let finalChange = validChange;
                        let newItems = (player.items && typeof player.items === 'object' && !Array.isArray(player.items)) 
                            ? { ...player.items } 
                            : { doubleCard: false, protectCard: false, lossProtectCard: false, vip: 0 };
                        let effectMessage = '';

                        // åŒå€ç§¯åˆ†å¡æ•ˆæœï¼šæ— è®ºè¾“èµ¢ï¼Œä½¿ç”¨ä¸€æ¬¡åå¤±æ•ˆ
                        if (player.items && player.items.doubleCard) {
                            // å¡ç‰‡ä½¿ç”¨åå¤±æ•ˆ
                            newItems.doubleCard = false;
                            
                            if (validChange > 0) {
                                // èµ¢é’±ï¼šç§¯åˆ†åŒå€
                                finalChange = validChange * 2;
                                effectMessage = `ï¼ˆåŒå€ç§¯åˆ†å¡ç”Ÿæ•ˆï¼š${validChange} Ã— 2 = ${finalChange}ï¼‰`;
                            } else {
                                // è¾“é’±æˆ–å¹³å±€ï¼šå¡ç‰‡å¤±æ•ˆï¼ˆä¸ç”Ÿæ•ˆï¼‰
                                effectMessage = effectMessage ? effectMessage + `ï¼ˆåŒå€ç§¯åˆ†å¡å¤±æ•ˆï¼‰` : `ï¼ˆåŒå€ç§¯åˆ†å¡å¤±æ•ˆï¼‰`;
                            }
                        }

                        // æ‰æ®µä¿æŠ¤å¡æ•ˆæœï¼šæ— è®ºè¾“èµ¢ï¼Œä½¿ç”¨ä¸€æ¬¡åå¤±æ•ˆ
                        if (player.items && player.items.protectCard) {
                            // å¡ç‰‡ä½¿ç”¨åå¤±æ•ˆ
                            newItems.protectCard = false;
                            
                            if (validChange < 0) {
                                // è¾“é’±æ—¶æ£€æŸ¥æ˜¯å¦ä¼šæ‰æ®µ
                                const currentScore = player.score;
                                const newScore = currentScore + validChange;
                                const currentRankMin = getCurrentRankMin(currentScore);
                                
                                // å¦‚æœä¼šæ‰æ®µï¼ˆæ–°åˆ†æ•°ä½äºå½“å‰æ®µä½çš„æœ€å°å€¼ï¼‰
                                if (newScore < currentRankMin) {
                                    // å°†åˆ†æ•°è°ƒæ•´åˆ°å½“å‰æ®µä½è¾¹ç¼˜
                                    finalChange = currentRankMin - currentScore;
                                    effectMessage = effectMessage ? effectMessage + `ï¼ˆæ‰æ®µä¿æŠ¤å¡ç”Ÿæ•ˆï¼šåˆ†æ•°ä¿æŠ¤åœ¨ ${currentRankMin}ï¼‰` : `ï¼ˆæ‰æ®µä¿æŠ¤å¡ç”Ÿæ•ˆï¼šåˆ†æ•°ä¿æŠ¤åœ¨ ${currentRankMin}ï¼‰`;
                                } else {
                                    // ä¸ä¼šæ‰æ®µï¼Œå¡ç‰‡å¤±æ•ˆï¼ˆä¸ç”Ÿæ•ˆï¼‰
                                    effectMessage = effectMessage ? effectMessage + `ï¼ˆæ‰æ®µä¿æŠ¤å¡å¤±æ•ˆï¼‰` : `ï¼ˆæ‰æ®µä¿æŠ¤å¡å¤±æ•ˆï¼‰`;
                                }
                            } else {
                                // èµ¢é’±æˆ–å¹³å±€ï¼šå¡ç‰‡å¤±æ•ˆï¼ˆä¸ç”Ÿæ•ˆï¼‰
                                effectMessage = effectMessage ? effectMessage + `ï¼ˆæ‰æ®µä¿æŠ¤å¡å¤±æ•ˆï¼‰` : `ï¼ˆæ‰æ®µä¿æŠ¤å¡å¤±æ•ˆï¼‰`;
                            }
                        }

                        // æ‰åˆ†ä¿æŠ¤å¡æ•ˆæœï¼šå¦‚æœè¾“äº†åˆ™ä¸æ‰£åˆ†ï¼Œæ— è®ºè¾“èµ¢éƒ½å¤±æ•ˆ
                        if (player.items && player.items.lossProtectCard) {
                            // å¡ç‰‡ä½¿ç”¨åå¤±æ•ˆ
                            newItems.lossProtectCard = false;
                            
                            if (validChange < 0) {
                                // è¾“é’±ï¼šä¸æ‰£åˆ†
                                finalChange = 0;
                                effectMessage = effectMessage ? effectMessage + `ï¼ˆæ‰åˆ†ä¿æŠ¤å¡ç”Ÿæ•ˆï¼šæœ¬æ¬¡ä¸æ‰£åˆ†ï¼‰` : `ï¼ˆæ‰åˆ†ä¿æŠ¤å¡ç”Ÿæ•ˆï¼šæœ¬æ¬¡ä¸æ‰£åˆ†ï¼‰`;
                            } else {
                                // èµ¢é’±æˆ–å¹³å±€ï¼šå¡ç‰‡å¤±æ•ˆï¼ˆä¸ç”Ÿæ•ˆï¼‰
                                effectMessage = effectMessage ? effectMessage + `ï¼ˆæ‰åˆ†ä¿æŠ¤å¡å¤±æ•ˆï¼‰` : `ï¼ˆæ‰åˆ†ä¿æŠ¤å¡å¤±æ•ˆï¼‰`;
                            }
                        }

                        // VIPä½¿ç”¨æ¬¡æ•°å¤„ç†ï¼šæ¯æ¬¡è®°åˆ†æ—¶å‡å°‘1æ¬¡ï¼Œå¦‚æœæ¬¡æ•°ä¸º0åˆ™å¤±æ•ˆ
                        if (player.items && player.items.vip && player.items.vip > 0) {
                            newItems.vip = player.items.vip - 1;
                            if (newItems.vip === 0) {
                                effectMessage = effectMessage ? effectMessage + `ï¼ˆVIPå·²å¤±æ•ˆï¼‰` : `ï¼ˆVIPå·²å¤±æ•ˆï¼‰`;
                            }
                        }

                        const newScore = player.score + finalChange;
                        const newGameCount = player.gameCount + 1;
                        const newWinCount = finalChange > 0 ? player.winCount + 1 : player.winCount;
                        const currentHistory = Array.isArray(player.history) ? player.history : [];
                        const newHistory = [...currentHistory, {
                            date: new Date().toLocaleString(),
                            change: finalChange,
                            originalChange: validChange,
                            newScore: newScore,
                            effect: effectMessage
                        }];
                        
                        return {
                            ...player,
                            score: newScore || 0,
                            gameCount: newGameCount || 0,
                            winCount: newWinCount || 0,
                            history: newHistory,
                            items: newItems
                        };
                    } else {
                        // æœªå‚åŠ ï¼šä¸æ›´æ–°å±€æ•°å’Œèƒœåœºï¼ŒVIPæ¬¡æ•°ä¹Ÿä¸å‡å°‘ï¼Œåªä¿ç•™åŸæœ‰æ•°æ®
                        // ç¡®ä¿è¿”å›æœ‰æ•ˆçš„å¯¹è±¡
                        return {
                            id: player.id,
                            name: player.name || '',
                            score: player.score || 0,
                            gameCount: player.gameCount || 0,
                            winCount: player.winCount || 0,
                            history: Array.isArray(player.history) ? player.history : [],
                            items: (player.items && typeof player.items === 'object' && !Array.isArray(player.items)) 
                                ? { ...player.items } 
                                : { doubleCard: false, protectCard: false, lossProtectCard: false, vip: 0 }
                        };
                    }
                }).filter(p => p !== null && p !== undefined); // è¿‡æ»¤æ‰nullå’Œundefinedå€¼
                setPlayers(updatedPlayers);
                // æ¸…ç©ºæœ¬å±€è¾“å…¥
                setRoundScores(prev => {
                    const cleared = {};
                    if (Array.isArray(players)) {
                        players.forEach(p => {
                            if (p && p.id) {
                                cleared[p.id] = '';
                            }
                        });
                    }
                    return cleared;
                });
                // å›åˆæ•°åŠ ä¸€
                setRoundCount(prev => prev + 1);
            };

            const resetAllData = () => {
                if (window.confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç§¯åˆ†æ•°æ®å—ï¼Ÿç©å®¶åˆ—è¡¨å’Œé“å…·å°†ä¿ç•™ï¼Œæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
                    // åªé‡ç½®ç§¯åˆ†ç›¸å…³æ•°æ®ï¼Œæ˜ç¡®ä¿ç•™ç©å®¶åˆ—è¡¨å’Œé“å…·
                    setPlayers(players.map(p => ({
                        ...p,
                        score: 0,
                        gameCount: 0,
                        winCount: 0,
                        history: [],
                        items: p.items || { doubleCard: false, protectCard: false, lossProtectCard: false, vip: 0 }  // æ˜ç¡®ä¿ç•™é“å…·
                    })));
                    setRoundScores({});
                    setRoundCount(0);
                }
            };

            const sortedPlayers = (Array.isArray(players) ? [...players] : []).sort((a, b) => b.score - a.score);
            const totalPlayers = Array.isArray(players) ? players.length : 0;
            const totalGames = roundCount;  // ä»¥å›åˆæ•°è¡¨ç¤ºæ€»å±€æ•°
            const averageScore = totalPlayers > 0 && Array.isArray(players) ? (players.reduce((sum, player) => sum + (player?.score || 0), 0) / totalPlayers).toFixed(1) : 0;

            return (
                <div className="container">
                    <div className="title">
                        <h1>ğŸ€„ ç»ˆæå››å­—éº»å°†æ®µä½ç»Ÿè®¡ç³»ç»Ÿ</h1>
                        <p>è®°å½•æ¯å±€å¾—å¤±ï¼Œè§è¯æ®µä½å‡é™</p>
                    </div>

                    <div className="stats-grid">
                        <div className="stat-card blue">
                            <div className="stat-content">
                                <Users className="stat-icon" />
                                <div className="stat-text">
                                    <h3>æ€»ç©å®¶æ•°</h3>
                                    <p>{totalPlayers}</p>
                                </div>
                            </div>
                        </div>
                        <div className="stat-card green">
                            <div className="stat-content">
                                <TrendingUp className="stat-icon" />
                                <div className="stat-text">
                                    <h3>æ€»å±€æ•°</h3>
                                    <p>{totalGames}</p>
                                </div>
                            </div>
                        </div>
                        <div className="stat-card purple">
                            <div className="stat-content">
                                <Award className="stat-icon" />
                                <div className="stat-text">
                                    <h3>å¹³å‡åˆ†æ•°</h3>
                                    <p>{averageScore}</p>
                                </div>
                            </div>
                        </div>
                        <div className="stat-card yellow">
                            <div className="stat-content">
                                <Trophy className="stat-icon" />
                                <div className="stat-text">
                                    <h3>å½“å‰æ¦œé¦–</h3>
                                    <p>{sortedPlayers[0]?.name || 'æš‚æ— '}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="main-grid">
                        <div>
                            <div className="card">
                                <h2>æ·»åŠ æ–°ç©å®¶</h2>
                                <div className="input-group">
                                    <input
                                        type="text"
                                        placeholder="è¾“å…¥ç©å®¶å§“å"
                                        value={newPlayerName}
                                        onChange={(e) => setNewPlayerName(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && addPlayer()}
                                    />
                                    <button onClick={addPlayer} className="btn btn-primary">
                                        <PlusCircle />
                                        æ·»åŠ 
                                    </button>
                                </div>
                            </div>

                            <div className="card">
                                <h2>è´¦å·ä¸­å¿ƒ</h2>
                                {currentUser.role === 'player' ? (
                                    <div>
                                        <p style={{marginBottom: '0.5rem', color: '#059669'}}>å½“å‰ç©å®¶ï¼š{players.find(p => p.id === currentUser.playerId)?.name || currentUser.username}</p>
                                        <button className="btn btn-danger" style={{width: '100%'}} onClick={logoutUser}>é€€å‡ºç™»å½•</button>
                                    </div>
                                ) : (
                                    <div>
                                        <div style={{display: 'flex', gap: '0.5rem', marginBottom: '0.75rem'}}>
                                            <button
                                                className="btn"
                                                style={{flex: 1, background: authMode === 'login' ? '#2563eb' : '#e5e7eb', color: authMode === 'login' ? '#fff' : '#1f2937'}}
                                                onClick={() => setAuthMode('login')}
                                            >
                                                ç™»å½•
                                            </button>
                                            <button
                                                className="btn"
                                                style={{flex: 1, background: authMode === 'register' ? '#2563eb' : '#e5e7eb', color: authMode === 'register' ? '#fff' : '#1f2937'}}
                                                onClick={() => setAuthMode('register')}
                                            >
                                                æ³¨å†Œ
                                            </button>
                                        </div>
                                        {authMode === 'login' ? (
                                            <div>
                                                <input
                                                    type="text"
                                                    placeholder="ç”¨æˆ·å"
                                                    value={authForm.username}
                                                    onChange={(e) => setAuthForm(prev => ({ ...prev, username: e.target.value }))}
                                                    style={{width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', marginBottom: '0.5rem'}}
                                                />
                                                <input
                                                    type="password"
                                                    placeholder="å¯†ç "
                                                    value={authForm.password}
                                                    onChange={(e) => setAuthForm(prev => ({ ...prev, password: e.target.value }))}
                                                    style={{width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', marginBottom: '0.5rem'}}
                                                />
                                                <button className="btn btn-success" style={{width: '100%'}} onClick={loginPlayer}>ç™»å½•</button>
                                            </div>
                                        ) : (
                                            <div>
                                                <input
                                                    type="text"
                                                    placeholder="ç”¨æˆ·å"
                                                    value={authForm.username}
                                                    onChange={(e) => setAuthForm(prev => ({ ...prev, username: e.target.value }))}
                                                    style={{width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', marginBottom: '0.5rem'}}
                                                />
                                                <input
                                                    type="text"
                                                    placeholder="æ˜¾ç¤ºæ˜µç§°ï¼ˆå¯é€‰ï¼‰"
                                                    value={authForm.displayName}
                                                    onChange={(e) => setAuthForm(prev => ({ ...prev, displayName: e.target.value }))}
                                                    style={{width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', marginBottom: '0.5rem'}}
                                                />
                                                <input
                                                    type="password"
                                                    placeholder="å¯†ç "
                                                    value={authForm.password}
                                                    onChange={(e) => setAuthForm(prev => ({ ...prev, password: e.target.value }))}
                                                    style={{width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', marginBottom: '0.5rem'}}
                                                />
                                                <input
                                                    type="password"
                                                    placeholder="ç¡®è®¤å¯†ç "
                                                    value={authForm.confirmPassword}
                                                    onChange={(e) => setAuthForm(prev => ({ ...prev, confirmPassword: e.target.value }))}
                                                    style={{width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', marginBottom: '0.5rem'}}
                                                />
                                                <button className="btn btn-success" style={{width: '100%'}} onClick={registerPlayer}>æ³¨å†Œ</button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            <div className="card">
                                <h2>è®°å½•æœ¬å±€åˆ†æ•°</h2>
                                {players.length > 0 ? (
                                    <div>
                                        {players.map(player => {
                                            const canEditScore = isAdmin || (currentUser.role === 'player' && currentUser.playerId === player.id);
                                            return (
                                                <div key={player.id} className="input-group">
                                                    <input
                                                        type="number"
                                                        placeholder={`${player.name} æœ¬å±€åˆ†æ•°å˜åŒ– ${canEditScore ? '(å¯ç•™ç©ºè§†ä¸º 0)' : '(æ— æƒé™)'}`}
                                                        value={roundScores[player.id] || ''}
                                                        onChange={(e) => {
                                                            if (!canEditScore) return;
                                                            setRoundScores(prev => ({ ...prev, [player.id]: e.target.value }));
                                                        }}
                                                        disabled={!canEditScore}
                                                        onKeyPress={(e) => e.key === 'Enter' && canEditScore && recordRound()}
                                                    />
                                                </div>
                                            );
                                        })}
                                        <button
                                            onClick={recordRound}
                                            disabled={players.length === 0 || (!isAdmin && currentUser.role !== 'player')}
                                            className="btn btn-success"
                                            style={{ marginTop: '0.5rem' }}
                                        >
                                            è®°å½•æœ¬å±€
                                        </button>
                                    </div>
                                ) : (
                                    <p style={{ color: '#6b7280' }}>è¯·å…ˆæ·»åŠ ç©å®¶</p>
                                )}
                            </div>

                            <div className="card">
                                <h2>ğŸ›’ ç§¯åˆ†å•†åŸ</h2>
                                {players.length > 0 ? (
                                    <div>
                                        {shopItems.map(item => {
                                            const IconComponent = item.icon;
                                            return (
                                                <div key={item.id} className="shop-item">
                                                    <div className="shop-item-header">
                                                        <IconComponent />
                                                        <span className="shop-item-name">{item.name}</span>
                                                        <span className="shop-item-price">{item.price} ç§¯åˆ†</span>
                                                    </div>
                                                    <div className="shop-item-desc">{item.description}</div>
                                                    <div className="shop-item-actions">
                                                        {currentUser.role === 'player' ? (
                                                            <div style={{flex: 1, fontSize: '0.875rem', color: '#1f2937'}}>
                                                                å½“å‰ç©å®¶ï¼š{players.find(p => p.id === currentUser.playerId)?.name || currentUser.username}
                                                            </div>
                                                        ) : (
                                                            <select
                                                                className="player-select"
                                                                value={selectedPlayerForShop || ''}
                                                                onChange={(e) => setSelectedPlayerForShop(e.target.value ? parseInt(e.target.value, 10) : null)}
                                                                disabled={!isAdmin}
                                                            >
                                                                <option value="">{isAdmin ? 'é€‰æ‹©ç©å®¶...' : 'è®¿å®¢æ— æ³•è´­ä¹°'}</option>
                                                                {players.map(p => (
                                                                    <option key={p.id} value={p.id}>
                                                                        {p.name} (ç§¯åˆ†: {p.score})
                                                                    </option>
                                                                ))}
                                                            </select>
                                                        )}
                                                        <button
                                                            onClick={() => {
                                                                if (currentUser.role === 'player' && currentUser.playerId) {
                                                                    buyItem(currentUser.playerId, item.id);
                                                                } else if (selectedPlayerForShop && isAdmin) {
                                                                    buyItem(selectedPlayerForShop, item.id);
                                                                } else {
                                                                    alert('è¯·å…ˆä»¥ç©å®¶èº«ä»½ç™»å½•ï¼Œæˆ–ç”±ç®¡ç†å‘˜é€‰æ‹©ç©å®¶');
                                                                }
                                                            }}
                                                            disabled={
                                                                (currentUser.role !== 'player' || !currentUser.playerId) &&
                                                                (!selectedPlayerForShop || !isAdmin)
                                                            }
                                                            className="btn btn-primary"
                                                        >
                                                            è´­ä¹°
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : (
                                    <p style={{ color: '#6b7280' }}>è¯·å…ˆæ·»åŠ ç©å®¶</p>
                                )}
                            </div>

                            <div className="card">
                                <h2>ç³»ç»Ÿæ“ä½œ</h2>
                                <div style={{marginBottom: '1rem'}}>
                                    <button 
                                        onClick={() => setShowFirebaseConfig(!showFirebaseConfig)}
                                        className="btn btn-primary"
                                        style={{width: '100%', marginBottom: '0.5rem'}}
                                    >
                                        {isFirebaseReady ? 'âœ… Firebaseå·²è¿æ¥' : 'âš™ï¸ é…ç½®Firebase'}
                                    </button>
                                    {isFirebaseReady && (
                                        <p style={{fontSize: '0.75rem', color: '#059669', marginBottom: '0.5rem', textAlign: 'center'}}>
                                            æ•°æ®å®æ—¶åŒæ­¥ä¸­...
                                        </p>
                                    )}
                                    <div style={{border: '1px solid #e5e7eb', borderRadius: '0.5rem', padding: '0.75rem', marginBottom: '0.5rem', background: '#fefce8'}}>
                                        <p style={{fontWeight: 'bold', marginBottom: '0.5rem', color: isAdmin ? '#16a34a' : '#b45309'}}>
                                            å½“å‰æ¨¡å¼ï¼š{isAdmin ? 'ç®¡ç†å‘˜ï¼ˆå¯å†™å…¥äº‘ç«¯ï¼‰' : 'è®¿å®¢ï¼ˆä»…æŸ¥çœ‹ï¼‰'}
                                        </p>
                                        {!isAdmin ? (
                                            <div>
                                                <input
                                                    type="password"
                                                    placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†ç "
                                                    value={passcodeInput}
                                                    onChange={(e) => setPasscodeInput(e.target.value)}
                                                    style={{width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', marginBottom: '0.5rem'}}
                                                />
                                                <button
                                                    className="btn btn-success"
                                                    style={{width: '100%'}}
                                                    onClick={() => {
                                                        if (passcodeInput === ADMIN_PASSCODE) {
                                                            setIsAdmin(true);
                                                            setPasscodeInput('');
                                                            alert('å·²åˆ‡æ¢ä¸ºç®¡ç†å‘˜æ¨¡å¼ï¼Œå¯ä»¥å†™å…¥Firebaseã€‚');
                                                        } else {
                                                            alert('å¯†ç é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚');
                                                        }
                                                    }}
                                                >
                                                    è¿›å…¥ç®¡ç†å‘˜æ¨¡å¼
                                                </button>
                                            </div>
                                        ) : (
                                            <button
                                                className="btn btn-danger"
                                                style={{width: '100%'}}
                                                onClick={() => {
                                                    if (confirm('ç¡®å®šè¦é€€å‡ºç®¡ç†å‘˜æ¨¡å¼å—ï¼Ÿé€€å‡ºåä»…å¯è¯»å–æ•°æ®ã€‚')) {
                                                        setIsAdmin(false);
                                                    }
                                                }}
                                            >
                                                é€€å‡ºç®¡ç†å‘˜æ¨¡å¼
                                            </button>
                                        )}
                                    </div>
                                    
                                    {showFirebaseConfig && (
                                        <div style={{
                                            border: '1px solid #e5e7eb',
                                            borderRadius: '0.5rem',
                                            padding: '1rem',
                                            marginBottom: '0.5rem',
                                            background: '#f9fafb'
                                        }}>
                                            <h3 style={{fontSize: '1rem', marginBottom: '0.75rem'}}>Firebaseé…ç½®</h3>
                                            <div style={{marginBottom: '0.5rem'}}>
                                                <label style={{display: 'block', fontSize: '0.875rem', marginBottom: '0.25rem', color: '#6b7280'}}>
                                                    API Key <span style={{color: '#dc2626'}}>*</span>
                                                </label>
                                                <input
                                                    type="text"
                                                    value={configInput.apiKey}
                                                    onChange={(e) => setConfigInput({...configInput, apiKey: e.target.value})}
                                                    placeholder="AIza..."
                                                    style={{width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem'}}
                                                />
                                            </div>
                                            <div style={{marginBottom: '0.5rem'}}>
                                                <label style={{display: 'block', fontSize: '0.875rem', marginBottom: '0.25rem', color: '#6b7280'}}>
                                                    Database URL <span style={{color: '#dc2626'}}>*</span>
                                                </label>
                                                <input
                                                    type="text"
                                                    value={configInput.databaseURL}
                                                    onChange={(e) => setConfigInput({...configInput, databaseURL: e.target.value})}
                                                    placeholder="https://xxx.firebaseio.com"
                                                    style={{width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem'}}
                                                />
                                            </div>
                                            <div style={{marginBottom: '0.5rem'}}>
                                                <label style={{display: 'block', fontSize: '0.875rem', marginBottom: '0.25rem', color: '#6b7280'}}>Project ID</label>
                                                <input
                                                    type="text"
                                                    value={configInput.projectId}
                                                    onChange={(e) => setConfigInput({...configInput, projectId: e.target.value})}
                                                    placeholder="å¯é€‰"
                                                    style={{width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem'}}
                                                />
                                            </div>
                                            <div style={{display: 'flex', gap: '0.5rem'}}>
                                                <button
                                                    onClick={() => {
                                                        if (!configInput.apiKey || !configInput.databaseURL) {
                                                            alert('è¯·è‡³å°‘å¡«å†™API Keyå’ŒDatabase URL');
                                                            return;
                                                        }
                                                        const config = {
                                                            apiKey: configInput.apiKey,
                                                            authDomain: configInput.authDomain,
                                                            databaseURL: configInput.databaseURL,
                                                            projectId: configInput.projectId,
                                                            storageBucket: configInput.storageBucket,
                                                            messagingSenderId: configInput.messagingSenderId,
                                                            appId: configInput.appId
                                                        };
                                                        if (initFirebase(config)) {
                                                            alert('Firebaseé…ç½®æˆåŠŸï¼æ•°æ®å°†å®æ—¶åŒæ­¥ã€‚');
                                                            setShowFirebaseConfig(false);
                                                        }
                                                    }}
                                                    className="btn btn-success"
                                                    style={{flex: 1}}
                                                >
                                                    ä¿å­˜é…ç½®
                                                </button>
                                                <button
                                                    onClick={() => setShowFirebaseConfig(false)}
                                                    className="btn"
                                                    style={{flex: 1, background: '#e5e7eb', color: '#1f2937'}}
                                                >
                                                    å–æ¶ˆ
                                                </button>
                                            </div>
                                            {isFirebaseReady && (
                                                <button
                                                    onClick={() => {
                                                        if (confirm('ç¡®å®šè¦æ–­å¼€Firebaseè¿æ¥å—ï¼Ÿå°†åˆ‡æ¢å›æœ¬åœ°å­˜å‚¨æ¨¡å¼ã€‚')) {
                                                            localStorage.removeItem('firebaseConfig');
                                                            setFirebaseConfig(null);
                                                            setDb(null);
                                                            setIsFirebaseReady(false);
                                                            setUseFirebase(false);
                                                            setShowFirebaseConfig(false);
                                                            window.location.reload();
                                                        }
                                                    }}
                                                    className="btn btn-danger"
                                                    style={{width: '100%', marginTop: '0.5rem'}}
                                                >
                                                    æ–­å¼€Firebaseè¿æ¥
                                                </button>
                                            )}
                                            <p style={{fontSize: '0.75rem', color: '#6b7280', marginTop: '0.5rem'}}>
                                                æç¤ºï¼šåœ¨Firebaseæ§åˆ¶å°åˆ›å»ºRealtime Databaseåï¼Œå¤åˆ¶é…ç½®ä¿¡æ¯åˆ°è¿™é‡Œã€‚
                                            </p>
                                        </div>
                                    )}
                                </div>
                                <button onClick={resetAllData} className="btn btn-danger" style={{width: '100%'}}>
                                    <Trash2 />
                                    é‡ç½®ç§¯åˆ†æ•°æ®
                                </button>
                            </div>
                        </div>

                        <div className="card">
                            <h2>ç©å®¶æ’è¡Œæ¦œ</h2>
                            <div className="player-list">
                                {sortedPlayers.map((player, index) => {
                                    const rankInfo = getRankInfo(player.score);
                                    const winRate = player.gameCount > 0 ? ((player.winCount / player.gameCount) * 100).toFixed(1) : 0;
                                    
                                    const isVip = player.items?.vip && player.items.vip > 0;
                                    return (
                                        <div key={player.id} className={`player-item ${isVip ? 'vip-card' : ''}`}>
                                            <div className="player-header">
                                                <div style={{display: 'flex', alignItems: 'center'}}>
                                                    <span className={`player-rank ${index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other'}`}>
                                                        #{index + 1}
                                                    </span>
                                                    {(player.items?.vip && player.items.vip > 0) ? (
                                                        <span className="vip-name" style={{fontWeight: 600}}>
                                                            <span className="vip-crown-icon">ğŸ‘‘</span>
                                                            {player.name}
                                                        </span>
                                                    ) : (
                                                        <span style={{fontWeight: 600, color: '#1f2937'}}>{player.name}</span>
                                                    )}
                                                </div>
                                                <button
                                                    onClick={() => deletePlayer(player.id)}
                                                    style={{background: 'none', border: 'none', color: '#ef4444', cursor: 'pointer'}}
                                                >
                                                    <Trash2 />
                                                </button>
                                            </div>
                                            
                                            <div className="player-stats">
                                                <div>
                                                    <p style={{color: '#6b7280'}}>åˆ†æ•°: <span style={{fontWeight: 'bold', color: player.score >= 0 ? '#059669' : '#dc2626'}}>{player.score}</span></p>
                                                    <p style={{color: '#6b7280'}}>èƒœç‡: <span style={{fontWeight: 'bold', color: '#2563eb'}}>{winRate}%</span></p>
                                                </div>
                                                <div>
                                                    <p style={{color: '#6b7280'}}>å±€æ•°: <span style={{fontWeight: 'bold'}}>{player.gameCount}</span></p>
                                                    <p style={{color: '#6b7280'}}>èƒœåœº: <span style={{fontWeight: 'bold', color: '#059669'}}>{player.winCount}</span></p>
                                                </div>
                                            </div>
                                            
                                            <div className="rank-info">
                                                <p className="rank-name">{rankInfo.name}</p>
                                                <p className="rank-desc">{rankInfo.description}</p>
                                            </div>
                                            
                                            {(player.items?.doubleCard || player.items?.protectCard || player.items?.lossProtectCard || (player.items?.vip && player.items.vip > 0)) && (
                                                <div style={{marginTop: '0.5rem', display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                                                    {player.items.doubleCard && (
                                                        <span className="item-badge" style={{display: 'flex', alignItems: 'center', gap: '0.25rem'}}>
                                                            {React.createElement(Zap, { width: 12, height: 12 })}
                                                            åŒå€ç§¯åˆ†å¡
                                                        </span>
                                                    )}
                                                    {player.items.protectCard && (
                                                        <span className="item-badge" style={{display: 'flex', alignItems: 'center', gap: '0.25rem'}}>
                                                            {React.createElement(Shield, { width: 12, height: 12 })}
                                                            æ‰æ®µä¿æŠ¤å¡
                                                        </span>
                                                    )}
                                                    {player.items.lossProtectCard && (
                                                        <span className="item-badge" style={{display: 'flex', alignItems: 'center', gap: '0.25rem'}}>
                                                            {React.createElement(Shield, { width: 12, height: 12 })}
                                                            æ‰åˆ†ä¿æŠ¤å¡
                                                        </span>
                                                    )}
                                                    {player.items.vip && player.items.vip > 0 && (
                                                        <span className="item-badge" style={{display: 'flex', alignItems: 'center', gap: '0.25rem', background: '#fef3c7', color: '#d97706'}}>
                                                            {React.createElement(Crown, { width: 12, height: 12 })}
                                                            VIP ({player.items.vip}æ¬¡)
                                                        </span>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                                
                                {players.length === 0 && (
                                    <div className="empty-state">
                                        <Trophy size={48} className="empty-icon" />
                                        <p>è¿˜æ²¡æœ‰ç©å®¶æ•°æ®</p>
                                        <p style={{fontSize: '0.875rem'}}>æ·»åŠ ç©å®¶å¼€å§‹è®°å½•å§ï¼</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="card">
                        <h2>æ®µä½è¡¨å‚è€ƒ</h2>
                        <div className="rank-table">
                            {rankTable.map((rank, index) => (
                                <div key={index} className="rank-item">
                                    <div className="rank-item-header">
                                        <span className="rank-item-name">{rank.name}</span>
                                        <span className="rank-item-range">{rank.min} ~ {rank.max}</span>
                                    </div>
                                    <p className="rank-item-desc">{rank.description}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<MahjongScoreTracker />, document.getElementById('root'));
    </script>
</body>
</html>
